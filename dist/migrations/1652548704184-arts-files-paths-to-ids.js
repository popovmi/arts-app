const{Logger}=require("@nestjs/common"),{access,copyFile,rm}=require("fs/promises"),{join}=require("path"),{MigrationInterface,QueryRunner}=require("typeorm"),{config}=require("dotenv");config(),module.exports=class artsFilesPathsToIds1652548704184{name="artsFilesPathsToIds1652548704184";logger=new Logger(artsFilesPathsToIds1652548704184.name);config={fileStoragePath:process.env.FILE_STORAGE_PATH};async up(queryRunner){const arts=await queryRunner.manager.query('select * from art a left join art_file af on af."artId" = a.id ');this.logger.log({arts});for(const art of arts){const origFilePath=art.originalPath,wmFilePath=art.watermarkPath,origFilePathParts=origFilePath.split("\\"),origExtension=origFilePathParts[origFilePathParts.length-1].split(".")[1],newOrigFilePath=origFilePathParts.join("\\");origFilePathParts[origFilePathParts.length-1]=join(`${art.id}.${origExtension}`),this.logger.log({origFilePath}),this.logger.log({newOrigFilePath});const wmFilePathParts=wmFilePath.split("\\"),wmExtension=wmFilePathParts[wmFilePathParts.length-1].split(".")[1],newWmFilePath=wmFilePathParts.join("\\");wmFilePathParts[wmFilePathParts.length-1]=join(`${art.id}.${wmExtension}`),this.logger.log({wmFilePath}),this.logger.log({newWmFilePath});try{const diskOrigPath=join(this.config.fileStoragePath,origFilePath),diskWmPath=join(this.config.fileStoragePath,wmFilePath),newDiskOrigPath=join(this.config.fileStoragePath,newOrigFilePath),newDiskWmPath=join(this.config.fileStoragePath,newWmFilePath);await access(diskOrigPath),await access(diskWmPath),await copyFile(diskOrigPath,newDiskOrigPath),await copyFile(diskWmPath,newDiskWmPath),await queryRunner.manager.query(`update art_file set "watermarkPath" = '${newWmFilePath}', "originalPath" = '${newOrigFilePath}'`)}catch(e){throw this.logger.error(e),e}}}async down(queryRunner){const arts=await queryRunner.manager.query('select * from art a left join art_file af on af."artId" = a.id ');this.logger.log({arts});for(const art of arts){const origFilePath=art.originalPath,wmFilePath=art.watermarkPath,origFilePathParts=origFilePath.split("\\"),origExtension=origFilePathParts[origFilePathParts.length-1].split(".")[1];origFilePathParts[origFilePathParts.length-1]=join(`${art.name}.${origExtension}`);const newOrigFilePath=origFilePathParts.join("\\");this.logger.log({origFilePath}),this.logger.log({newOrigFilePath});const wmFilePathParts=wmFilePath.split("\\"),wmExtension=wmFilePathParts[wmFilePathParts.length-1].split(".")[1];wmFilePathParts[wmFilePathParts.length-1]=join(`${art.name}.${wmExtension}`);const newWmFilePath=wmFilePathParts.join("\\");this.logger.log({wmFilePath}),this.logger.log({newWmFilePath});try{const diskOrigPath=join(this.config.fileStoragePath,origFilePath),diskWmPath=join(this.config.fileStoragePath,wmFilePath),newDiskOrigPath=join(this.config.fileStoragePath,newOrigFilePath),newDiskWmPath=join(this.config.fileStoragePath,newWmFilePath);await access(diskOrigPath),await access(diskWmPath),await copyFile(diskOrigPath,newDiskOrigPath),await copyFile(diskWmPath,newDiskWmPath),await queryRunner.manager.query(`update art_file set "watermarkPath" = '${newWmFilePath}', "originalPath" = '${newOrigFilePath}'`)}catch(e){throw this.logger.error(e),e}}}};