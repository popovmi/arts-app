const{Logger}=require("@nestjs/common"),{readdir}=require("fs/promises"),{join}=require("path");module.exports=class fixArtsFilesPaths1653991278349{name="fixArtsFilesPaths1653991278349";logger=new Logger(fixArtsFilesPaths1653991278349.name);config={fileStoragePath:process.env.FILE_STORAGE_PATH,nodeEnv:process.env.NODE_ENV};async up(queryRunner){const originalFiles=await readdir(join(this.config.fileStoragePath,"original")),watermarkFiles=await readdir(join(this.config.fileStoragePath,"watermark"));[originalFiles,watermarkFiles].forEach((array=>{array.includes(".gitignore")&&array.splice(array.findIndex((elem=>".gitignore"===elem)),1)}));for(const file of originalFiles){const[fileName,extension]=file.split("."),[art]=await queryRunner.query(`\n\t\t\t\tselect\n\t\t\t\t\t*\n\t\t\t\tfrom\n\t\t\t\t\tart a\n\t\t\t\tleft join art_file af\n\t\t\t\t\ton af."artId" = a.id\n\t\t\t\twhere\n\t\t\t\t\ta."createdAt" < '2022-05-30'\n\t\t\t\t\tand\ta.name = '${fileName}'\n\t\t\t`);art&&await queryRunner.query(`\n\t\t\t\t\tupdate\n\t\t\t\t\t\tart_file af\n\t\t\t\t\tset\n\t\t\t\t\t\t"originalPath" = 'original\\${art.id}.${extension}'\n\t\t\t\t\twhere af."artId" = '${art.id}'\n\t\t\t\t`)}for(const file of watermarkFiles){const[fileName,extension]=file.split("."),[art]=await queryRunner.query(`\n\t\t\t\tselect\n\t\t\t\t\t*\n\t\t\t\tfrom \n\t\t\t\t\tart a \n\t\t\t\tleft join art_file af \n\t\t\t\t\ton af."artId" = a.id \n\t\t\t\twhere\n\t\t\t\t\ta."createdAt" < '2022-05-30'\n\t\t\t\t\tand\ta.name = '${fileName}'\n\t\t\t\t `);art&&await queryRunner.query(`\n\t\t\t\t\tupdate\n\t\t\t\t\t\tart_file af\n\t\t\t\t\tset\n\t\t\t\t\t\t"watermarkPath" = 'watermark\\${art.id}.${extension}'\n\t\t\t\t\twhere af."artId" = '${art.id}'\n\t\t\t\t`)}}async down(queryRunner){await queryRunner.query("select 1")}};